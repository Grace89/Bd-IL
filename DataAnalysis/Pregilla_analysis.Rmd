---
title: 'Pilot Experiment: *Pseudacris regilla*'
author: "G. V. DiRenzo, A. Gershman, R. Chen, M. Toothman, C. J. Briggs"
date: "September 26, 2017"
output:
  html_document: default
  pdf_document: default
---
## This file contains data analysis for the first phase
## Days: 0 to 22

## Table of Contents
*Click on specific sections of the document to jump to them*

[I. Study objective][]

[II. Data Visualization][]

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[II.I Combined plot][]

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[II.II Individual plot][]

[III. Summary stats of changes in Bd load over time][]

[IV. Statistical analyses][]

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[IV.I Linear mixed effects models][]

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[IV.II T-test comparing 1st day infection to last day (day = 14) infection][]


# I. Study objective
(1) To determine if BMP clears *Bd* infection as efficently and/or quickly as ITCZ

## Experiment information
Study species: *Pseudacris regilla*

Total number of animals: 20

Sample size per treatment: 5 to 8 animals

Animals were treated with Bd for 3 consecutive days.

Animals were treated with Itraconazole for 7 consecutive days.

Animals were treated with BMP twice

Experimental days: 0 to 22

# II. Data Visualization
# II.I Combined plot
This plot shows the relationship between experimental day and *Bd* load on the log scale across treatments in one plot.

```{r echo = FALSE, cache=FALSE, message=FALSE, warning= FALSE}
#read in data 
dat<-read.csv("~/Dropbox/BDIL/Data/P_regilla/BdIL_all_9_19.csv")

# Create empty vector to add in sample size to names of the treatments
Sample_size <-numeric(nrow(dat))

# Replace the name of the treatment with name + sample size
Sample_size[grep("BMP", dat$Treatment)] <- "BMP [n = 8]"
Sample_size[grep("Control", dat$Treatment)] <- "Control [n = 5]"
Sample_size[grep("ITCZ", dat$Treatment)] <- "ITCZ [n = 7]"

# Add the sample size to the data frame
dat$Sample_size <- Sample_size

# Multiply each Bd column by 80 (the dilution factor)
dat$Bd_load_1 <- dat$Quantity_1 * 80
dat$Bd_load_2 <- dat$Quantity_2 * 80
dat$Bd_load_3 <- dat$Quantity_3 * 80

# Create a 2-D matrix with the 2 Quantites
Bd_load <- cbind(dat$Bd_load_1, dat$Bd_load_2, dat$Bd_load_3)

# Estimate the means for Bd load over the 2 runs
dat$Bd_load <- rowMeans(Bd_load, na.rm = TRUE)

# There are 2 phases of the experiment
	# 1st BMP treatment
	# 2nd BMP treatment
phase <- numeric(nrow(dat))

# If Exp_day == 6, 9, or 14 = 1st phase
# Everything else is 2nd phase.
phase <- ifelse(dat$Exp_day == "6" |dat$Exp_day == "9" | dat$Exp_day == "14" , 1, 2)

library(ggplot2)

ggplot(dat,
               aes(y = log10(Bd_load + 1), x = (Exp_day-6))) +
  ylab(expression(paste(log[10], "(", italic(Bd), "load + 1)", sep = ""))) +
  geom_point(aes(color= Sample_size), position = position_jitterdodge()) + 
  stat_smooth(aes(color = Sample_size, fill = Sample_size), se = TRUE, method = "lm") + 
  theme_bw() + 
  geom_vline(xintercept = 0, lty = 6) + annotate("text", label = "BMP treat", x = 0, y = 3, size = 3)+
  geom_vline(xintercept = 1:6, lty = 3) + annotate("text", label = "ITCZ treat (7 days)", x = 3, y = 3, size = 3)+  
  geom_vline(xintercept = 6, lty = 6) + annotate("text", label = "BMP treat", x = 6, y = 3, size = 3)+
  scale_colour_manual(name = "Treatment & \nSample Size", values = c("skyblue", "black","goldenrod"))+
   scale_fill_manual(name = "Treatment & \nSample Size", values = c("skyblue", "black","goldenrod"))+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        axis.text.y=element_text(size=9),
        axis.title.y=element_text(size=9),
        axis.text.x=element_text(size=9),
        axis.title.x=element_text(size=9),
        legend.title = element_text(size=7),
        legend.text = element_text(size=7),
        legend.direction = "vertical") + xlab("Experimental day")

#setwd("/Users/Cici/Dropbox/BDIL/Figures")
#ggsave("P_reg_pathogen_load.pdf", height = 6, width = 9)
```

# II.II Individual plot
This plot shows individual infection histories.
```{r echo = FALSE, cache=FALSE, message=FALSE, warning= FALSE, fig.align= "center", fig.height = 4.5, fig.width = 8}

dat2 <- data.frame(Treatment = dat$Treatment, Frog_ID = dat$Frog_ID)

dat2$combo <- paste(dat2$Treatment, dat2$Frog_ID, sep = "_")

uniqueID <- numeric(nrow(dat2))

for(i in dat2$Treatment){
    treatment <- grep(i, dat2$Treatment)
    treatment_IDs <- unique(dat2[treatment,]$Frog_ID)
    treatment_IDs <- droplevels(treatment_IDs)

    for(j in 1:length(treatment_IDs)){
      values <-  which(dat2$Frog_ID %in% treatment_IDs[j])
      uniqueID[values] <- j
    }
}

dat$uniqueID <- uniqueID  

ggplot(dat, aes(y = log10(Bd_load + 1), x = (Exp_day-6))) +
  ylab(expression(paste(log[10], "(", italic(Bd), "load + 1)", sep = ""))) +
  geom_point(aes(color= Sample_size)) + 
  facet_grid(uniqueID ~ Sample_size)+
  geom_line(aes(y = log10(Bd_load + 1), x = (Exp_day-6)))+
  theme_bw() + 
  scale_colour_manual(name = "Treatment & \nSample Size", values = c("skyblue", "black","goldenrod"))+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        axis.text.y=element_text(size=9),
        axis.title.y=element_text(size=9),
        axis.text.x=element_text(size=9),
        axis.title.x=element_text(size=9),
        legend.position = "none") + xlab("Experimental day")
#setwd("/Users/Cici/Dropbox/BDIL/Figures")
#ggsave("P_reg_pathogen_load_IND.pdf", height = 6, width = 9)
```

# III. Summary stats of changes in Bd load over time
The number of BMP treated animals that cleared their infection-
```{r echo = FALSE}
dat$Exp_day <- dat$Exp_day - 6
BMP <- dat[dat$Treatment == "BMP" & dat$Exp_day == 16,]
length(which(BMP$Bd_load== 0))
```

Infection on first day-
```{r echo = FALSE}
First_day <- mean(dat[dat$Exp_day == 0 & dat$Treatment == "BMP", ]$Bd_load)
First_day
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 0 & dat$Treatment == "BMP", ]$Bd_load)/length(dat[dat$Exp_day == 0 & dat$Treatment == "BMP", ]$Bd_load)
```

Last day-
```{r echo = FALSE}
last_dat <- mean(dat[dat$Exp_day == 16 & dat$Treatment == "BMP", ]$Bd_load)
last_dat
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 16 & dat$Treatment == "BMP", ]$Bd_load)/length(dat[dat$Exp_day == 16 & dat$Treatment == "BMP", ]$Bd_load)
```

Percent change in Bd load-
```{r echo = FALSE}
((First_day -last_dat) /First_day) * 100
```

## Control animals:
Number of animals that cleared infection- 
```{r echo = FALSE}
Control <- dat[dat$Treatment == "Control" & dat$Exp_day == 16,]
(length(which(Control$Bd_load == 0)))
```

Infection on first day-
```{r echo = FALSE}
First_day <- mean(dat[dat$Exp_day == 0 & dat$Treatment == "Control", ]$Bd_load)
First_day
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 0 & dat$Treatment == "Control", ]$Bd_load)/length(dat[dat$Exp_day == 0 & dat$Treatment == "Control", ]$Bd_load)
```

Infection on last day-
```{r echo = FALSE}
last_dat <- mean(dat[dat$Exp_day == 16 & dat$Treatment == "Control", ]$Bd_load)
last_dat
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 16 & dat$Treatment == "Control", ]$Bd_load)/length(dat[dat$Exp_day == 16 & dat$Treatment == "Control", ]$Bd_load)
```

Percent change in Bd load-
```{r echo = FALSE}
((First_day - last_dat) /First_day)* 100
```

##ITCZ
The number of Itraconozole animals that cleared their infection-
```{r echo = FALSE}
ITCZ <- dat[dat$Treatment == "ITCZ" & dat$Exp_day == 16,]
length(which(ITCZ$Bd_load == 0))
```

Infection on first day-
```{r echo = FALSE}
First_day <- mean(dat[dat$Exp_day == 0 & dat$Treatment == "ITCZ", ]$Bd_load)
First_day
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 0 & dat$Treatment == "ITCZ", ]$Bd_load)/length(dat[dat$Exp_day == 0 & dat$Treatment == "ITCZ", ]$Bd_load)
```

Infection on last day-
```{r echo = FALSE}
last_dat <- mean(dat[dat$Exp_day == 16 & dat$Treatment == "ITCZ", ]$Bd_load)
last_dat
```

Standard error-
```{r echo = FALSE}
sd(dat[dat$Exp_day == 16 & dat$Treatment == "ITCZ", ]$Bd_load)/length(dat[dat$Exp_day == 16 & dat$Treatment == "ITCZ", ]$Bd_load)
```

Percent change in Bd load-
```{r echo = FALSE}
((First_day - last_dat) /First_day)* 100
```


# IV. Statistical analyses

# IV.I Linear mixed effects models
We fit a linear mixed effects model to the data where the intercept and the slope differ, and individuals are treated as replicates:

# Model 1
```{r, echo = FALSE, warnings = FALSE}
library(nlme)
library(lme4)
dat$stand_day <- (dat$Exp_day - mean(dat$Exp_day))/sd(dat$Exp_day)

# statistical analysis
mod.lme <- lme(log10(Bd_load + 1) ~ Treatment*stand_day, random = ~1|Frog_ID, data=dat)
summary(mod.lme)

library(plyr)
col <- ddply(.data = dat, .variable = c("Frog_ID", "Treatment"),
      .fun = summarize,
      mean = mean(Bd_load))
col$col <- NA

for(i in 1:nrow(col)){
  if(col$Treatment[i] == "Control") {col$col[i] <- "black"}
  if(col$Treatment[i] == "BMP") {col$col[i] <- "skyblue"}
  if(col$Treatment[i] == "ITCZ") {col$col[i] <- "goldenrod"}
}

dat2 <- data.frame(stand_day = rep(seq(from = 0, to = 16), times = 3),
                   Treatment = rep(levels(dat$Treatment), each = 17))

dat$pred <- predict(mod.lme, dat, type = "response")

#BMP = "skyblue"
#control = "black"
#ITCZ = "goldenrod"

ggplot()+  geom_line(data = dat, aes(y = (pred), x = stand_day, col = Frog_ID))+ scale_color_manual(values = col$col)

p_reg <- ggplot(dat, aes(y = log10(Bd_load+1), x = (Exp_day-6))) +
  ylab(expression(paste(log[10], "(", italic(Bd), "load + 1)", sep = ""))) +
  geom_point(aes(color= Frog_ID), position = position_jitter()) + 
  geom_line(aes(y = (pred), x = Exp_day-6, color = Frog_ID))+
  scale_color_manual(values = col$col)+
  theme_bw()+
  geom_vline(xintercept = 0, lty = 6) + 
  annotate("text", label = "BMP treat", x = 0, y = 3.75, size = 3)+
  geom_vline(xintercept = 1:6, lty = 3) + 
  annotate("text", label = "ITCZ treat (7 days)", x = 3, y = 3.75, size = 3)+  
  geom_vline(xintercept = 6, lty = 6) + 
  annotate("text", label = "BMP treat", x = 6, y = 3.75, size = 3)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=12),
        axis.text.x=element_text(size=12),
        axis.title.x=element_text(size=12),
        legend.title = element_text(size=12),
        legend.text = element_text(size=12),
        legend.direction = "vertical",
        legend.position = "none") + 
  xlab("Experimental day")+ 
  ggtitle(expression(italic("Pseudacris regilla")))

```

```{r, echo = FALSE}
#plot(ranef(mod.lme))
#res_lme=residuals(mod.lme)
#plot(res_lme)
#qqnorm(res_lme)
#qqline(res_lme)
#plot(mod.lme)
```

# Post-hoc comparison of the slopes of each treatment
```{r, warning = FALSE, echo = FALSE}
library(lsmeans)
lst = lsmeans::lstrends(mod.lme, ~Treatment, var= "stand_day")
slopes <- cld(lst)
slopes
```

# Trying to improve the fit

We tried to include various correlation structure, but that didn't seem to improve the fit.

## Model 2
```{r echo = FALSE}
mod.lme2 <- lme(log10(Bd_load + 1) ~ Treatment*stand_day, random= ~ 1|Frog_ID,correlation=corARMA(0.2, form=~stand_day|Frog_ID, p=1, q=0), data=dat)
summary(mod.lme2)
```

# Post-hoc comparison of the slopes of each treatment
```{r, warning = FALSE, echo = FALSE}
library(lsmeans)
lst = lsmeans::lstrends(mod.lme2, ~Treatment, var= "stand_day")
slopes <- cld(lst)
slopes
```

## Model 3
```{r echo = FALSE}
mod.lme3 <- lme(log10(Bd_load + 1) ~ Treatment*stand_day, random= ~ 1|Frog_ID,correlation=corAR1(0.2,form=~stand_day|Frog_ID), data=dat)
summary(mod.lme3)
```

# Post-hoc comparison of the slopes of each treatment
```{r, warning = FALSE, echo = FALSE}
library(lsmeans)
lst = lsmeans::lstrends(mod.lme3, ~Treatment, var= "stand_day")
slopes <- cld(lst)
slopes
```

# Model selection
```{r, echo = FALSE, warning= FALSE}
library(AICcmodavg)
cand.mods <- list()
cand.mods[[1]] <- mod.lme
cand.mods[[2]] <- mod.lme2
cand.mods[[3]] <- mod.lme3

aictab(cand.mods)
```

# IV.II T-test comparing 1st day infection to last day (day = 22) infection

##BMP
```{r, echo = FALSE}
BMP <- dat[dat$Treatment == "BMP", ]
BMP <- BMP[BMP$Exp_day == "0" | BMP$Exp_day == "16",]
BMP$Exp_day <- as.factor(BMP$Exp_day)
t.test(log10(BMP$Bd_load+1) ~ BMP$Exp_day)
```

##Control
```{r, echo = FALSE}
Control <- dat[dat$Treatment == "Control", ]
Control <- Control[Control$Exp_day == "0" | Control$Exp_day == "16",]
Control$Exp_day <- as.factor(Control$Exp_day)
t.test(log10(Control$Bd_load+1) ~ Control$Exp_day)
```

##ITCZ
```{r, echo = FALSE}
ITCZ <- dat[dat$Treatment == "ITCZ", ]
ITCZ <- ITCZ[ITCZ$Exp_day == "0" | ITCZ$Exp_day == "16",]
ITCZ$Exp_day <- as.factor(ITCZ$Exp_day)
t.test(log10(ITCZ$Bd_load+1) ~ ITCZ$Exp_day)
```